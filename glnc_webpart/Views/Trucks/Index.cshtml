@model List<glnc_webpart.Models.Truck>
@{
    ViewData["Title"] = "Trucks Management";
}

<div class="page-container">
    <div class="page-header">
        <h1>Trucks Management</h1>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTruckModal">
            <i class="bi bi-plus-circle"></i> 
        </button>
    </div>

    <div class="table-container">
        <table class="table table-striped table-hover table-centered">
            <thead>
                <tr>
                    <th>License</th>
                    <th>Brand</th>
                    <th>Model</th>
                    <th>Color</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var truck in Model)
                {
                    <tr>
                        <td>@truck.License</td>
                        <td>@truck.Brand</td>
                        <td>@truck.Model</td>
                        <td>
                            @{
                                string colorValue = truck.Color;
                                if (!string.IsNullOrEmpty(colorValue) && !colorValue.StartsWith("#"))
                                {
                                    colorValue = "#" + colorValue;
                                }
                                if (string.IsNullOrEmpty(colorValue))
                                {
                                    colorValue = "#ffffff";
                                }
                            }
                            <div class="d-flex align-items-center justify-content-center gap-2">
                                <div class="color-swatch" style="width: 30px; height: 30px; background-color: @colorValue; border: 1px solid #ddd; border-radius: 4px; display: inline-block; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                                <span>@truck.Color</span>
                            </div>
                        </td>
                        <td>
                            <button class="btn btn-icon btn-edit" onclick="editTruck(@truck.Id)" title="Edit Truck">
                                <i class="bi bi-pencil-square"></i>
                            </button>
                            <button class="btn btn-icon btn-delete delete-truck-btn" data-truck-id="@truck.Id" data-truck-license="@truck.License" title="Delete Truck">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Create Truck Modal -->
<div class="modal fade" id="createTruckModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Truck</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="createTruckForm">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">License <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="License" required maxlength="250" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Brand <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="Brand" required maxlength="50" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Model <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="Model" required maxlength="50" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Color <span class="text-danger">*</span></label>
                        <div class="d-flex align-items-center gap-2">
                            <input type="color" class="form-control form-control-color" name="Color" id="createTruckColor" value="#ffffff" required style="width: 60px; height: 38px; cursor: pointer;" />
                            <input type="text" class="form-control" id="createTruckColorText" placeholder="#ffffff" maxlength="7" style="flex: 1;" />
                        </div>
                        <small class="form-text text-muted">Select a color or enter a hex code</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Truck Modal -->
<div class="modal fade" id="editTruckModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Truck</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editTruckForm">
                @Html.AntiForgeryToken()
                <input type="hidden" name="Id" id="editTruckId" />
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">License</label>
                        <input type="text" class="form-control" name="License" id="editTruckLicense" required maxlength="250" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Brand</label>
                        <input type="text" class="form-control" name="Brand" id="editTruckBrand" required maxlength="50" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Model</label>
                        <input type="text" class="form-control" name="Model" id="editTruckModel" required maxlength="50" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Color</label>
                        <div class="d-flex align-items-center gap-2">
                            <input type="color" class="form-control form-control-color" name="Color" id="editTruckColor" required style="width: 60px; height: 38px; cursor: pointer;" />
                            <input type="text" class="form-control" id="editTruckColorText" placeholder="#ffffff" maxlength="7" style="flex: 1;" />
                        </div>
                        <small class="form-text text-muted">Select a color or enter a hex code</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Truck Confirmation Modal -->
<div class="modal fade" id="deleteTruckModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this truck? This action cannot be undone.</p>
                <p class="text-muted mb-0"><strong>License:</strong> <span id="deleteTruckLicense"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteTruckBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Toast Notification Function
        function showToast(message, type = 'success') {
            const toastContainer = $('#toastContainer');
            const toastId = 'toast-' + Date.now();
            
            const toastConfig = {
                success: { bgClass: 'bg-success', icon: 'bi-check-circle-fill', title: 'Success' },
                error: { bgClass: 'bg-danger', icon: 'bi-x-circle-fill', title: 'Error' },
                warning: { bgClass: 'bg-warning', icon: 'bi-exclamation-triangle-fill', title: 'Warning' },
                info: { bgClass: 'bg-info', icon: 'bi-info-circle-fill', title: 'Info' }
            };
            
            const config = toastConfig[type] || toastConfig.success;
            
            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-white ${config.bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="bi ${config.icon} me-2"></i>
                            <strong>${config.title}:</strong> ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            
            toastContainer.append(toastHtml);
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { autohide: true, delay: 5000 });
            toast.show();
            
            toastElement.addEventListener('hidden.bs.toast', function() {
                toastElement.remove();
            });
        }

        function getToken() {
            return $('input[name="__RequestVerificationToken"]').val();
        }

        // Helper function to normalize color value (ensure it starts with #)
        function normalizeColor(color) {
            if (!color) return '#ffffff';
            color = color.trim();
            if (!color.startsWith('#')) {
                color = '#' + color;
            }
            // Ensure it's a valid hex color (6 characters after #)
            if (color.length === 4) {
                // Expand shorthand (#fff to #ffffff)
                color = '#' + color[1] + color[1] + color[2] + color[2] + color[3] + color[3];
            }
            return color.substring(0, 7); // Limit to #RRGGBB format
        }

        // Sync color picker and text input for Create modal
        $('#createTruckColor').on('input', function() {
            $('#createTruckColorText').val($(this).val());
        });

        $('#createTruckColorText').on('input', function() {
            let color = normalizeColor($(this).val());
            if (/^#[0-9A-Fa-f]{6}$/.test(color)) {
                $('#createTruckColor').val(color);
            }
        });

        // Sync color picker and text input for Edit modal
        $('#editTruckColor').on('input', function() {
            $('#editTruckColorText').val($(this).val());
        });

        $('#editTruckColorText').on('input', function() {
            let color = normalizeColor($(this).val());
            if (/^#[0-9A-Fa-f]{6}$/.test(color)) {
                $('#editTruckColor').val(color);
            }
        });

        // On form submit, ensure color value is used from picker
        $('#createTruckForm').on('submit', function(e) {
            // Normalize color before submit
            let colorValue = normalizeColor($('#createTruckColor').val());
            $('#createTruckColor').val(colorValue);
            $('#createTruckColorText').val(colorValue);
            e.preventDefault();
            $.ajax({
                url: '@Url.Action("Create", "Trucks")',
                type: 'POST',
                data: $(this).serialize(),
                headers: { 'RequestVerificationToken': getToken() },
                success: function(response) {
                    if (response.success) {
                        $('#createTruckModal').modal('hide');
                        $('#createTruckForm')[0].reset();
                        showToast('Truck created successfully!', 'success');
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    } else {
                        showToast(response.message || 'Failed to create truck', 'error');
                    }
                },
                error: function() {
                    showToast('An error occurred. Please try again.', 'error');
                }
            });
        });

        function editTruck(id) {
            $.get('@Url.Action("Get", "Trucks")', { id: id }, function(response) {
                if (response.success) {
                    $('#editTruckId').val(response.data.id);
                    $('#editTruckLicense').val(response.data.license);
                    $('#editTruckBrand').val(response.data.brand);
                    $('#editTruckModel').val(response.data.model);
                    
                    // Normalize and set color value
                    let colorValue = normalizeColor(response.data.color);
                    $('#editTruckColor').val(colorValue);
                    $('#editTruckColorText').val(colorValue);
                    
                    $('#editTruckModal').modal('show');
                }
            });
        }

        $('#editTruckForm').on('submit', function(e) {
            e.preventDefault();
            // Normalize color before submit
            let colorValue = normalizeColor($('#editTruckColor').val());
            $('#editTruckColor').val(colorValue);
            $('#editTruckColorText').val(colorValue);
            $.ajax({
                url: '@Url.Action("Edit", "Trucks")',
                type: 'POST',
                data: $(this).serialize(),
                headers: { 'RequestVerificationToken': getToken() },
                success: function(response) {
                    if (response.success) {
                        $('#editTruckModal').modal('hide');
                        showToast('Truck updated successfully!', 'success');
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    } else {
                        showToast(response.message || 'Failed to update truck', 'error');
                    }
                },
                error: function() {
                    showToast('An error occurred. Please try again.', 'error');
                }
            });
        });

        // Store truck data for deletion
        let truckIdToDelete = null;

        // Delete Truck - Show confirmation modal (using data attributes)
        $(document).on('click', '.delete-truck-btn', function() {
            const truckId = $(this).data('truck-id');
            const truckLicense = $(this).data('truck-license');
            truckIdToDelete = truckId;
            $('#deleteTruckLicense').text(truckLicense);
            $('#deleteTruckModal').modal('show');
        });

        // Confirm Delete - Execute deletion
        $('#confirmDeleteTruckBtn').on('click', function() {
            if (truckIdToDelete) {
                $.ajax({
                    url: '@Url.Action("Delete", "Trucks")',
                    type: 'POST',
                    data: { 
                        id: truckIdToDelete,
                        __RequestVerificationToken: getToken()
                    },
                    success: function(response) {
                        $('#deleteTruckModal').modal('hide');
                        if (response.success) {
                            showToast('Truck deleted successfully!', 'success');
                            setTimeout(function() {
                                location.reload();
                            }, 1000);
                        } else {
                            showToast(response.message || 'Failed to delete truck', 'error');
                        }
                        truckIdToDelete = null;
                    },
                    error: function() {
                        $('#deleteTruckModal').modal('hide');
                        showToast('An error occurred. Please try again.', 'error');
                        truckIdToDelete = null;
                    }
                });
            }
        });

        // Clear stored truck ID when modal is closed
        $('#deleteTruckModal').on('hidden.bs.modal', function() {
            truckIdToDelete = null;
        });

        // Initialize pagination
        $(document).ready(function() {
            initPagination('.table-container table', 10);
        });
    </script>
}

