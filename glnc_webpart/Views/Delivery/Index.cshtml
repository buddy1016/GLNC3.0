@model List<glnc_webpart.Models.Delivery>
@{
    ViewData["Title"] = "Gestion des livraisons";
}

<div class="page-container">
    <div class="page-header">
        <h1>Gestion des livraisons</h1>
    </div>

    <div class="table-container">
        <table class="table table-striped table-hover table-centered" id="deliveryTable">
            <thead>
                <tr>
                    <th>Client</th>
                    <th>Contact</th>
                    <th>Camion</th>
                    <th>Date de rendez-vous</th>
                    <th>Accepté</th>
                    <th>Arrivée</th>
                    <th>Statut</th>
                    <th>Satisfaction du client</th>
                    <th>Comment</th>
                    <th>Fournisseur</th>
                    <th>Photo</th>
                    <th>Facture</th>
                    <th>Poids</th>
                    <th>Actes</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var delivery in Model)
                {
                    <tr>
                        <td>@delivery.Client</td>
                        <td>@delivery.Contacts</td>
                        <td>@(delivery.Truck?.License ?? "N/A")</td>
                        <td>@delivery.DateTimeAppointment.ToString("yyyy-MM-dd HH:mm")</td>
                        <td>@(delivery.DateTimeAccept?.ToString("yyyy-MM-dd HH:mm") ?? "-")</td>
                        <td>@(delivery.DateTimeArrival?.ToString("yyyy-MM-dd HH:mm") ?? "-")</td>
                        <td>
                            @if (delivery.ReturnFlag)
                            {
                                <span class="badge bg-danger">Retour</span>
                            }
                            else if (delivery.DateTimeArrival.HasValue)
                            {
                                <span class="badge bg-success">Complété</span>
                            }
                            else if (delivery.DateTimeAccept.HasValue)
                            {
                                <span class="badge bg-warning">En cours</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">En attente</span>
                            }
                        </td>
                        <td>
                            @if (delivery.SatisfactionClient.HasValue)
                            {
                                @delivery.SatisfactionClient
                            }
                            else
                            {
                                <text>-</text>
                            }
                        </td>
                        <td>
                            @if (!string.IsNullOrEmpty(delivery.Comment))
                            {
                                <span title="@delivery.Comment">@(delivery.Comment.Length > 30 ? delivery.Comment.Substring(0, 30) + "..." : delivery.Comment)</span>
                            }
                            else
                            {
                                <text>-</text>
                            }
                        </td>
                        <td>@(delivery.Supplier?.SupplierName ?? "N/A")</td>
                        <td>
                            <button class="btn btn-link p-0 btn-view-invoice" 
                                    data-delivery-id="@delivery.Id"
                                    title="View Invoice Photo"
                                    style="border: none; background: none; cursor: pointer;">
                                <i class="bi bi-search" style="font-size: 1.2rem; color: #333;"></i>
                            </button>
                        </td>
                        <td>@delivery.Invoice</td>
                        <td>@delivery.Weight kg</td>
                        <td>
                            <button class="btn btn-icon btn-info" onclick="viewDelivery(@delivery.Id)" title="View Delivery">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-icon btn-edit" onclick="editDelivery(@delivery.Id)" title="Edit Delivery">
                                <i class="bi bi-pencil-square"></i>
                            </button>
                            <button class="btn btn-icon btn-delete" 
                                    data-delivery-id="@delivery.Id" 
                                    data-delivery-client="@delivery.Client"
                                    title="Delete Delivery">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Edit Delivery Modal -->
<div class="modal fade" id="editDeliveryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Modifier la livraison</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editDeliveryForm">
                @Html.AntiForgeryToken()
                <input type="hidden" name="Id" id="editDeliveryId" />
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nom du client</label>
                            <input type="text" class="form-control" name="Client" id="editDeliveryClient" required maxlength="250" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Adresse</label>
                            <input type="text" class="form-control" name="Address" id="editDeliveryAddress" required maxlength="250" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Contacts du client</label>
                            <input type="text" class="form-control" name="Contacts" id="editDeliveryContacts" required maxlength="250" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Facture</label>
                            <input type="text" class="form-control" name="Invoice" id="editDeliveryInvoice" required maxlength="250" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Date de rendez-vous</label>
                            <input type="datetime-local" class="form-control" name="DateTimeAppointment" id="editDeliveryAppointment" required />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Date de départ</label>
                            <input type="datetime-local" class="form-control" name="DateTimeLeave" id="editDeliveryLeave" required />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Fournisseur</label>
                            <select class="form-select" name="SupplierId" id="editDeliverySupplier" required>
                                @foreach (var supplier in ViewBag.Suppliers as List<glnc_webpart.Models.Supplier>)
                                {
                                    <option value="@supplier.Id">@supplier.SupplierName</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Camion</label>
                            <select class="form-select" name="TruckId" id="editDeliveryTruck" required>
                                @foreach (var truck in ViewBag.Trucks as List<glnc_webpart.Models.Truck>)
                                {
                                    <option value="@truck.Id">@truck.License - @truck.Brand @truck.Model</option>
                                }
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Poids</label>
                        <input type="number" step="0.01" class="form-control" name="Weight" id="editDeliveryWeight" required />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">Mettre à jour</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Delivery Modal -->
<div class="modal fade" id="viewDeliveryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Détails de la livraison</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="viewDeliveryContent"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<!-- Invoice Image Modal -->
<div class="modal fade" id="invoiceImageModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Photo de la facture</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="invoiceImageDisplay" src="" alt="Invoice Photo" class="img-fluid" style="max-height: 70vh; width: auto;" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteDeliveryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmation de suppression</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Êtes-vous sûr de vouloir supprimer cette livraison? Cette action ne peut pas être annulée.</p>
                <p class="text-muted mb-0"><strong>Nom du client:</strong> <span id="deleteDeliveryClient"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteDeliveryBtn">Supprimer</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function getToken() {
            return $('input[name="__RequestVerificationToken"]').val();
        }

        function viewDelivery(id) {
            $.get('@Url.Action("Details", "Delivery")', { id: id }, function(html) {
                $('#viewDeliveryContent').html(html);
                $('#viewDeliveryModal').modal('show');
            }).fail(function() {
                showToast('Une erreur est survenue lors du chargement des détails de la livraison', 'error');
            });
        }

        // Handle invoice image view using event delegation
        $(document).on('click', '.btn-view-invoice', function() {
            const deliveryId = $(this).data('delivery-id');
            viewInvoiceImage(deliveryId);
        });

        function viewInvoiceImage(deliveryId) {
            // Fetch delivery details to get invoice image
            $.get('@Url.Action("Get", "Delivery")', { id: deliveryId }, function(response) {
                if (response.success && response.data) {
                    const invoiceImage = response.data.invoiceImage || response.data.InvoiceImage;
                    
                    if (!invoiceImage || invoiceImage === '' || invoiceImage === null) {
                        showToast('Aucune photo de facture disponible pour cette livraison.', 'warning');
                        return;
                    }

                    // Check if imageData is a base64 string or a URL
                    let imageSrc = '';
                    if (invoiceImage.startsWith('data:image')) {
                        // Already a base64 data URL
                        imageSrc = invoiceImage;
                    } else if (invoiceImage.startsWith('http://') || invoiceImage.startsWith('https://')) {
                        // It's a URL
                        imageSrc = invoiceImage;
                    } else {
                        // Assume it's a base64 string without the data URL prefix
                        imageSrc = 'data:image/png;base64,' + invoiceImage;
                    }

                    // Set the image source and show modal
                    $('#invoiceImageDisplay').attr('src', imageSrc);
                    $('#invoiceImageModal').modal('show');

                    // Handle image load error (remove previous handlers first)
                    $('#invoiceImageDisplay').off('error').on('error', function() {
                        $('#invoiceImageModal').modal('hide');
                        showToast('Échec du chargement de la photo de facture. L\'image peut être corrompue ou invalide.', 'error');
                    });
                } else {
                    showToast('Aucune photo de facture disponible pour cette livraison.', 'warning');
                }
            }).fail(function() {
                showToast('Une erreur est survenue lors du chargement de la photo de facture.', 'error');
            });
        }

        function showToast(message, type = 'success') {
            const toastContainer = $('#toastContainer');
            const toastId = 'toast-' + Date.now();
            
            // Define toast configuration based on type
            const toastConfig = {
                success: {
                    bgClass: 'bg-success',
                    icon: 'bi-check-circle-fill',
                    title: 'Succès'
                },
                error: {
                    bgClass: 'bg-danger',
                    icon: 'bi-x-circle-fill',
                    title: 'Erreur'
                },
                warning: {
                    bgClass: 'bg-warning',
                    icon: 'bi-exclamation-triangle-fill',
                    title: 'Avertissement'
                },
                info: {
                    bgClass: 'bg-info',
                    icon: 'bi-info-circle-fill',
                    title: 'Information'
                }
            };
            
            const config = toastConfig[type] || toastConfig.success;
            
            const toastHtml = `
                <div id="${toastId}" class="toast ${config.bgClass} text-white" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="3000">
                    <div class="toast-header ${config.bgClass} text-white">
                        <i class="bi ${config.icon} me-2"></i>
                        <strong class="me-auto">${config.title}</strong>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                    <div class="toast-body">
                        ${message}
                    </div>
                </div>
            `;
            
            toastContainer.append(toastHtml);
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
            
            // Remove toast element after it's hidden
            toastElement.addEventListener('hidden.bs.toast', function() {
                toastElement.remove();
            });
        }

        function editDelivery(id) {
            $.get('@Url.Action("Get", "Delivery")', { id: id }, function(response) {
                if (response.success) {
                    const d = response.data;
                    // Store original delivery data to preserve fields not in form
                    originalDeliveryData = d;
                    
                    $('#editDeliveryId').val(d.id);
                    $('#editDeliveryClient').val(d.client);
                    $('#editDeliveryAddress').val(d.address);
                    $('#editDeliveryContacts').val(d.contacts);
                    $('#editDeliveryInvoice').val(d.invoice);
                    $('#editDeliveryAppointment').val(new Date(d.dateTimeAppointment).toISOString().slice(0, 16));
                    $('#editDeliveryLeave').val(new Date(d.dateTimeLeave).toISOString().slice(0, 16));
                    $('#editDeliverySupplier').val(d.supplierId);
                    $('#editDeliveryTruck').val(d.truckId);
                    $('#editDeliveryWeight').val(d.weight);
                    $('#editDeliveryModal').modal('show');
                } else {
                    showToast('Échec du chargement des données de la livraison', 'error');
                }
            }).fail(function() {
                showToast('Une erreur est survenue lors du chargement des données de la livraison', 'error');
            });
        }

        $('#editDeliveryForm').on('submit', function(e) {
            e.preventDefault();
            
            if (!originalDeliveryData) {
                showToast('Erreur: Données de livraison non trouvées. Veuillez rafraîchir et réessayer.', 'error');
                return;
            }
            
            // Build JSON object from form data, preserving fields not in form
            const deliveryData = {
                Id: parseInt($('#editDeliveryId').val()),
                Client: $('#editDeliveryClient').val().trim(),
                Address: $('#editDeliveryAddress').val().trim(),
                Contacts: $('#editDeliveryContacts').val().trim(),
                Invoice: $('#editDeliveryInvoice').val().trim(),
                DateTimeAppointment: new Date($('#editDeliveryAppointment').val()).toISOString(),
                DateTimeLeave: new Date($('#editDeliveryLeave').val()).toISOString(),
                SupplierId: parseInt($('#editDeliverySupplier').val()),
                TruckId: parseInt($('#editDeliveryTruck').val()),
                Weight: parseFloat($('#editDeliveryWeight').val()),
                UserId: originalDeliveryData.userId || originalDeliveryData.UserId,
                // Preserve fields not in form
                DateTimeAccept: originalDeliveryData.dateTimeAccept ? new Date(originalDeliveryData.dateTimeAccept).toISOString() : null,
                DateTimeArrival: originalDeliveryData.dateTimeArrival ? new Date(originalDeliveryData.dateTimeArrival).toISOString() : null,
                Description: originalDeliveryData.description || null,
                SignClient: originalDeliveryData.signClient || null,
                SatisfactionClient: originalDeliveryData.satisfactionClient || null,
                ReturnFlag: originalDeliveryData.returnFlag !== undefined ? originalDeliveryData.returnFlag : false,
                Comment: originalDeliveryData.comment || '',
                InvoiceImage: originalDeliveryData.invoiceImage || null
            };
            
            $.ajax({
                url: '@Url.Action("Edit", "Delivery")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(deliveryData),
                headers: { 'RequestVerificationToken': getToken() },
                success: function(response) {
                    if (response.success) {
                        $('#editDeliveryModal').modal('hide');
                        // Reset original delivery data
                        originalDeliveryData = null;
                        showToast('Livraison mise à jour avec succès!', 'success');
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    } else {
                        showToast(response.message || 'Échec de la mise à jour de la livraison', 'error');
                    }
                },
                error: function(xhr) {
                    let errorMsg = 'Une erreur est survenue. Veuillez réessayer.';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMsg = xhr.responseJSON.message;
                    }
                    showToast(errorMsg, 'error');
                }
            });
        });

        // Store delivery ID for deletion
        let deliveryIdToDelete = null;
        
        // Store original delivery data to preserve fields not in form
        let originalDeliveryData = null;

        // Delete Delivery - Show confirmation modal (using event delegation)
        $(document).on('click', '.btn-delete[data-delivery-id]', function() {
            const deliveryId = $(this).data('delivery-id');
            const deliveryClient = $(this).data('delivery-client');
            deliveryIdToDelete = deliveryId;
            $('#deleteDeliveryClient').text(deliveryClient);
            $('#deleteDeliveryModal').modal('show');
        });

        // Confirm Delete - Execute deletion
        $('#confirmDeleteDeliveryBtn').on('click', function() {
            if (deliveryIdToDelete) {
                $.ajax({
                    url: '@Url.Action("Delete", "Delivery")',
                    type: 'POST',
                    data: { 
                        id: deliveryIdToDelete,
                        __RequestVerificationToken: getToken()
                    },
                    success: function(response) {
                        $('#deleteDeliveryModal').modal('hide');
                        if (response.success) {
                            showToast('Livraison supprimée avec succès!', 'success');
                            setTimeout(function() {
                                location.reload();
                            }, 1000);
                        } else {
                            showToast(response.message || 'Échec de la suppression de la livraison', 'error');
                        }
                        deliveryIdToDelete = null;
                    },
                    error: function() {
                        $('#deleteDeliveryModal').modal('hide');
                        showToast('Une erreur est survenue. Veuillez réessayer.', 'error');
                        deliveryIdToDelete = null;
                    }
                });
            }
        });

        // Clear stored delivery ID when modal is closed
        $('#deleteDeliveryModal').on('hidden.bs.modal', function() {
            deliveryIdToDelete = null;
        });

        // Initialize pagination
        $(document).ready(function() {
            initPagination('#deliveryTable', 10);
        });
    </script>
}

